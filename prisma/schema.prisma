generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  phone        String?
  firstName    String?
  lastName     String?

  role         String   @default("client")

  referralCode String   @unique
  referredBy   String?
  refCount     Int      @default(0)

  phoneVerified     Boolean  @default(false)
  referralValidated Boolean  @default(false)
  fraudScore        Int      @default(0)

  waitlistClients      Int @default(0)
  waitlistInfluencers  Int @default(0)
  waitlistPros         Int @default(0)

  appDownloads         Int @default(0)
  validatedInfluencers Int @default(0)
  validatedPros        Int @default(0)

  earlyBird       Boolean @default(false)
  earlyBirdBonus  Int     @default(0)

  points            Int @default(0)
  provisionalPoints Int @default(0)
  finalPoints       Int @default(0)
  rank              Int @default(0)
  nextMilestone     Int @default(10)
  lastRefAt         DateTime?

  eligibleForJackpot Boolean @default(false)
  isTopRank          Boolean @default(false)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  emailSentAt       DateTime?
  emailOpenedAt     DateTime?
  lastMilestoneSent Int?

  referralEventsAsReferrer ReferralEvent[] @relation("Referrer")
  referralEventsAsReferred ReferralEvent[] @relation("Referred")

  @@index([email])
  @@index([referralCode])
  @@index([provisionalPoints])
  @@index([finalPoints])
  @@index([createdAt])
}

model ReferralEvent {
  id             String   @id @default(cuid())
  type           String
  actor1Id       String
  actor2Id       String?
  roleAtSignup   String?
  pointsAwarded  Int      @default(0)
  createdAt      DateTime @default(now())

  actor1 User  @relation("Referrer", fields: [actor1Id], references: [id], onDelete: Cascade)
  actor2 User? @relation("Referred", fields: [actor2Id], references: [id], onDelete: SetNull)

  @@index([actor1Id])
  @@index([actor2Id])
  @@index([createdAt])
  @@index([type])
}
